<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuvo oauth2 SDK demo</title>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <script>
      const radios = document.querySelectorAll('input[name=network]')
      radios.forEach((radio) => {
        radio.addEventListener('change', (event) => {
          document.querySelector('#Oauth2 iframe').src = event.target.value
        })
      })

      const getNetwork = () => {
        let network = ''
        document.querySelectorAll('input[name=network]').forEach((e) => {
          if (e.checked) {
            network = e.value
          }
        })
        return network
      }

      const getLoginType = () => {
        let loginType = ''
        document.querySelectorAll('input[name=login-type]').forEach((e) => {
          if (e.checked) {
            loginType = e.value
          }
        })
        return loginType
      }

      const popupLogin = () => {
        const windowName = 'Nuvo oauth2 SDK'
        // 新窗口的宽度和高度
        const windowWidth = 480
        const windowHeight = 551

        // 计算屏幕居中位置
        const screenLeft = window.screenLeft || window.screenX
        const screenTop = window.screenTop || window.screenY
        const screenWidth =
          window.innerWidth || document.documentElement.clientWidth || screen.width
        const screenHeight =
          window.innerHeight || document.documentElement.clientHeight || screen.height

        const left = screenWidth / 2 - windowWidth / 2 + screenLeft
        const top = screenHeight / 2 - windowHeight / 2 + screenTop

        // 配置新窗口的特性
        const windowFeatures = `width=${windowWidth},height=${windowHeight},left=${left},top=${top},menubar=no,toolbar=no,location=no,scrollbars=yes`

        // 使用 window.open 方法打开新的窗口
        const popup = window.open(getNetwork(), windowName, windowFeatures)

        // 检查 popup 是否成功打开
        if (!popup) {
          alert('window.open 新窗口被浏览器阻止，请检查浏览器设置。')
        }
      }

      const iframeLogin = () => {
        document.querySelector('#Oauth2').style.display = 'flex'
      }

      document.querySelector('.login').addEventListener('click', () => {
        const type = getLoginType()
        if (type === 'popup') {
          popupLogin()
        } else if (type === 'iframe') {
          iframeLogin()
        }
      })

      document.querySelector('#Oauth2').addEventListener('click', (event) => {
        document.querySelector('#Oauth2').style.display = 'none'
      })

      window.addEventListener('message', async (event) => {
        const url = new URL(getNetwork())
        if (event.origin === url.origin) {
          if (event.data === 'close') {
            document.querySelector('#Oauth2').style.display = 'none'
          } else if (event.data?.type === 'login-success') {
            const code = event.data.code
            console.log('🌊 Code', code)
            const host = 'https://backoffice.staging.nuvosphere.io/dex'
            fetch(host + '/api/v1/login/user/token?code=' + code)
              .then((res) => res.json())
              .then((res) => {
                const token = res.data?.token
                console.log('🌊 Token', token)
                fetch(host + '/api/v1/user/info', {
                  headers: { Authorization: 'Bearer ' + token },
                })
                  .then((res) => res.json())
                  .then((res) => {
                    console.log('🌊 UserInfo', res.data)
                  })
              })
          }
        }
      })
    </script>
  </body>
</html>
