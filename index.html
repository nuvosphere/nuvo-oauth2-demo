<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuvo oauth2 SDK demo</title>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <script>
      const radios = document.querySelectorAll('input[name=network]')
      radios.forEach((radio) => {
        radio.addEventListener('change', (event) => {
          document.querySelector('#Oauth2 iframe').src = event.target.value
        })
      })

      const getNetwork = () => {
        let network = ''
        document.querySelectorAll('input[name=network]').forEach((e) => {
          if (e.checked) {
            network = e.value
          }
        })
        return network
      }

      const getLoginType = () => {
        let loginType = ''
        document.querySelectorAll('input[name=login-type]').forEach((e) => {
          if (e.checked) {
            loginType = e.value
          }
        })
        return loginType
      }

      const popupLogin = () => {
        const windowName = 'Nuvo oauth2 SDK'
        // æ–°çª—å£çš„å®½åº¦å’Œé«˜åº¦
        const windowWidth = 480
        const windowHeight = 551

        // è®¡ç®—å±å¹•å±…ä¸­ä½ç½®
        const screenLeft = window.screenLeft || window.screenX
        const screenTop = window.screenTop || window.screenY
        const screenWidth =
          window.innerWidth || document.documentElement.clientWidth || screen.width
        const screenHeight =
          window.innerHeight || document.documentElement.clientHeight || screen.height

        const left = screenWidth / 2 - windowWidth / 2 + screenLeft
        const top = screenHeight / 2 - windowHeight / 2 + screenTop

        // é…ç½®æ–°çª—å£çš„ç‰¹æ€§
        const windowFeatures = `width=${windowWidth},height=${windowHeight},left=${left},top=${top},menubar=no,toolbar=no,location=no,scrollbars=yes`

        // ä½¿ç”¨ window.open æ–¹æ³•æ‰“å¼€æ–°çš„çª—å£
        const popup = window.open(getNetwork(), windowName, windowFeatures)

        // æ£€æŸ¥ popup æ˜¯å¦æˆåŠŸæ‰“å¼€
        if (!popup) {
          alert('window.open æ–°çª—å£è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ã€‚')
        }
      }

      const iframeLogin = () => {
        document.querySelector('#Oauth2').style.display = 'flex'
      }

      document.querySelector('.login').addEventListener('click', () => {
        const type = getLoginType()
        if (type === 'popup') {
          popupLogin()
        } else if (type === 'iframe') {
          iframeLogin()
        }
      })

      document.querySelector('#Oauth2').addEventListener('click', (event) => {
        document.querySelector('#Oauth2').style.display = 'none'
      })

      window.addEventListener('message', async (event) => {
        const url = new URL(getNetwork())
        if (event.origin === url.origin) {
          if (event.data === 'close') {
            document.querySelector('#Oauth2').style.display = 'none'
          } else if (event.data?.type === 'login-success') {
            const code = event.data.code
            console.log('ðŸŒŠ Code', code)
            const host = 'https://backoffice.staging.nuvosphere.io/dex'
            fetch(host + '/api/v1/login/user/token?code=' + code)
              .then((res) => res.json())
              .then((res) => {
                const token = res.data?.token
                console.log('ðŸŒŠ Token', token)
                fetch(host + '/api/v1/user/info', {
                  headers: { Authorization: 'Bearer ' + token },
                })
                  .then((res) => res.json())
                  .then((res) => {
                    console.log('ðŸŒŠ UserInfo', res.data)
                  })
              })
          }
        }
      })
    </script>
  </body>
</html>
